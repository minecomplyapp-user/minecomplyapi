generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model User {
  id                 String              @id @default(uuid())
  supabaseId         String              @unique
  email              String?             @unique
  displayName        String?
  phoneNumber        String?
  role               UserRole            @default(PROPONENT)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  createdECCReports  ECCReport[]         @relation("UserCreatedECCReports")
  createdCMVRReports CMVRReport[]        @relation("UserCreatedCMVRReports")
  validations        ValidationSession[] @relation("ValidationReviewer")
  attendanceRecords  AttendanceRecord[]  @relation("UserAttendanceRecords")
}

model ECCReport {
  id             String   @id @default(uuid())
  generalInfo    Json?
  mmtInfo        Json?
  monitoringData Json?
  createdById    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  permitHolder   String?
  createdBy      User?    @relation("UserCreatedECCReports", fields: [createdById], references: [id])

  @@index([createdById], map: "idx_ecc_report_creator")
}

model CMVRReport {
  id                           String   @id @default(uuid())
  generalInfo                  Json?
  executiveSummaryOfCompliance Json?
  complianceMonitoringReport   Json?
  discussions                  Json?
  createdById                  String?
  createdAt                    DateTime @default(now())
  updatedAt                    DateTime @updatedAt
  createdBy                    User?    @relation("UserCreatedCMVRReports", fields: [createdById], references: [id])

  @@index([createdById], map: "idx_cmvr_report_creator")
}

model ValidationSession {
  id           String            @id @default(uuid())
  submissionId String
  reviewerId   String
  status       ValidationStatus  @default(IN_PROGRESS)
  summary      String?
  startedAt    DateTime          @default(now())
  completedAt  DateTime?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  reviewer     User              @relation("ValidationReviewer", fields: [reviewerId], references: [id])
  entries      ValidationEntry[]

  @@index([submissionId], map: "idx_validation_submission")
  @@index([reviewerId], map: "idx_validation_reviewer")
}

model ValidationEntry {
  id             String            @id @default(uuid())
  validationId   String
  status         ValidationOutcome @default(APPROVED)
  fieldValue     Decimal?          @db.Decimal(12, 4)
  fieldUnit      String?
  comparisonData Json?
  notes          String?
  recommendation String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  validation     ValidationSession @relation(fields: [validationId], references: [id])

  @@index([validationId], map: "idx_validation_entry_session")
}

model AttendanceRecord {
  id          String    @id @default(uuid())
  reportId    String?
  fileName    String
  title       String?
  description String?
  meetingDate DateTime?
  location    String?
  attendees   Json
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdById String?
  createdBy   User?     @relation("UserAttendanceRecords", fields: [createdById], references: [id])

  @@index([reportId], map: "idx_attendance_record_report")
  @@index([createdById], map: "idx_attendance_record_creator")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model ECCCondition {
  id               BigInt    @id @default(autoincrement())
  created_at       DateTime  @default(now()) @db.Timestamptz(6)
  updated_at       DateTime? @db.Timestamp(6)
  condition        String?
  status           String?   @db.VarChar
  remarks          String?
  ECCReportID      String?   @db.VarChar
  nested_to        String?   @db.VarChar
  condition_number Int?
}

enum UserRole {
  PROPONENT
  MMT
  REGULATOR
  ADMIN
}

enum OrganizationType {
  PROPONENT
  MMT
  REGULATOR
  GOVERNMENT
  OTHER
}

enum OrganizationMembershipRole {
  OWNER
  MANAGER
  CONTRIBUTOR
  REVIEWER
  OBSERVER
}

enum ProjectAssignmentRole {
  PROPONENT_EDITOR
  MMT_REVIEWER
  REGULATOR_VIEWER
}

enum ConditionType {
  ECC
  EPEP
  OTHER
}

enum ComplianceCategory {
  AIR
  WATER
  NOISE
  HAZARDOUS_WASTE
  FINANCIAL
  SOCIAL
  INFRASTRUCTURE
  BIODIVERSITY
  OTHER
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REVISIONS_REQUIRED
  ARCHIVED
}

enum ValidationStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  NEEDS_INFORMATION
}

enum ValidationOutcome {
  APPROVED
  CONDITIONALLY_APPROVED
  REQUIRES_CORRECTION
  REJECTED
  NOT_APPLICABLE
}

enum ReportType {
  CMR
  CMVR
  SUMMARY
  OTHER
}

enum EvidenceType {
  PHOTO
  VIDEO
  DOCUMENT
  AUDIO
  DATASET
  OTHER
}

enum AttendanceStatus {
  IN_PERSON
  ONLINE
  ABSENT
}
