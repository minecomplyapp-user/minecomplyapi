generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model User {
  id                 String              @id @default(uuid())
  supabaseId         String              @unique
  email              String?             @unique
  displayName        String?
  phoneNumber        String?
  role               UserRole            @default(PROPONENT)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  createdECCReports  ECCReport[]         @relation("UserCreatedECCReports")
  createdCMVRReports CMVRReport[]        @relation("UserCreatedCMVRReports")
  validations        ValidationSession[] @relation("ValidationReviewer")
  attendanceRecords  AttendanceRecord[]  @relation("UserAttendanceRecords")
}

model ECCReport {
  id                            String   @id @default(uuid())
  generalInfo                   Json?
  mmtInfo                       Json?
  monitoringData                Json?
  createdById                   String?
  createdAt                     DateTime @default(now())
  updatedAt                     DateTime @updatedAt
  permit_holders                String[]
  remarks_list                  Json?
  filename                      String?  @db.VarChar
  recommendations               String[] @db.VarChar
  permit_holder_with_conditions Json?
  createdBy                     User?    @relation("UserCreatedECCReports", fields: [createdById], references: [id])

  @@index([createdById], map: "idx_ecc_report_creator")
}

model CMVRReport {
  id          String   @id @default(uuid())
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  cmvrData    Json?
  fileName    String?  @db.VarChar
  createdBy   User?    @relation("UserCreatedCMVRReports", fields: [createdById], references: [id])

  @@index([createdById], map: "idx_cmvr_report_creator")
}

model ValidationSession {
  id           String            @id @default(uuid())
  submissionId String
  reviewerId   String
  status       ValidationStatus  @default(IN_PROGRESS)
  summary      String?
  startedAt    DateTime          @default(now())
  completedAt  DateTime?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  reviewer     User              @relation("ValidationReviewer", fields: [reviewerId], references: [id])
  entries      ValidationEntry[]

  @@index([submissionId], map: "idx_validation_submission")
  @@index([reviewerId], map: "idx_validation_reviewer")
}

model ValidationEntry {
  id             String            @id @default(uuid())
  validationId   String
  status         ValidationOutcome @default(APPROVED)
  fieldValue     Decimal?          @db.Decimal(12, 4)
  fieldUnit      String?
  comparisonData Json?
  notes          String?
  recommendation String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  validation     ValidationSession @relation(fields: [validationId], references: [id])

  @@index([validationId], map: "idx_validation_entry_session")
}

model AttendanceRecord {
  id          String    @id @default(uuid())
  reportId    String?
  fileName    String
  title       String?
  description String?
  meetingDate DateTime?
  location    String?
  attendees   Json
  attachments Json      @default("[]")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdById String?
  createdBy   User?     @relation("UserAttendanceRecords", fields: [createdById], references: [id])

  @@index([reportId], map: "idx_attendance_record_report")
  @@index([createdById], map: "idx_attendance_record_creator")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model ECCCondition {
  id               BigInt   @id @default(autoincrement())
  created_at       DateTime @default(now()) @db.Timestamptz(6)
  condition        String?  @db.VarChar
  status           String?  @db.VarChar
  remarks          String?
  ECCReportID      String?  @db.VarChar
  nested_to        Int?
  condition_number Int?
  remark_list      String[]
  section          Int?     @db.SmallInt
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model profiles {
  id              String    @id @db.Uuid
  email           String?   @unique
  first_name      String?
  last_name       String?
  full_name       String?
  position        String?
  mailing_address String?
  telephone       String?
  phone_number    String?
  fax             String?
  verified        Boolean?  @default(false)
  created_at      DateTime? @default(now()) @db.Timestamptz(6)
  updated_at      DateTime? @db.Timestamptz(6)
  qr_path         String?
  qr_public_url   String?
}

enum UserRole {
  PROPONENT
  MMT
  REGULATOR
  ADMIN
}

enum ValidationStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  NEEDS_INFORMATION
}

enum ValidationOutcome {
  APPROVED
  CONDITIONALLY_APPROVED
  REQUIRES_CORRECTION
  REJECTED
  NOT_APPLICABLE
}
