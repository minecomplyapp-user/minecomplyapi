generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model User {
  id                 String              @id @default(uuid())
  supabaseId         String              @unique
  email              String?             @unique
  displayName        String?
  phoneNumber        String?
  role               UserRole            @default(PROPONENT)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  createdSubmissions Submission[]        @relation("UserCreatedSubmissions")
  validations        ValidationSession[] @relation("ValidationReviewer")
  attendanceRecords  AttendanceRecord[]  @relation("UserAttendanceRecords")
}

model Submission {
  id                 String              @id @default(uuid())
  type               SubmissionType
  generalInfo        Json?
  mmtInfo            Json?
  monitoringData     Json?
  createdById        String?
  createdBy          User?               @relation("UserCreatedSubmissions", fields: [createdById], references: [id])
}

enum SubmissionType {
  ECC_MONITORING
  CMVR
  EPEP_AEPEP
}



model ValidationSession {
  id           String            @id @default(uuid())
  submissionId String
  reviewerId   String
  status       ValidationStatus  @default(IN_PROGRESS)
  summary      String?
  startedAt    DateTime          @default(now())
  completedAt  DateTime?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  reviewer     User              @relation("ValidationReviewer", fields: [reviewerId], references: [id])
  entries      ValidationEntry[]

  @@index([submissionId], map: "idx_validation_submission")
  @@index([reviewerId], map: "idx_validation_reviewer")
}

model ValidationEntry {
  id                 String            @id @default(uuid())
  validationId       String
  status             ValidationOutcome @default(APPROVED)
  fieldValue         Decimal?          @db.Decimal(12, 4)
  fieldUnit          String?
  comparisonData     Json?
  notes              String?
  recommendation     String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  validation         ValidationSession @relation(fields: [validationId], references: [id])

  @@index([validationId], map: "idx_validation_entry_session")
}

model AttendanceRecord {
  id          String   @id @default(uuid())
  reportId    String?
  createdById String?
  fileName    String
  title       String?
  description String?
  meetingDate DateTime?
  location    String?
  attendees   Json     // Array of attendee objects: { name, agency, office, position, signatureUrl, attendanceStatus }
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   User?    @relation("UserAttendanceRecords", fields: [createdById], references: [id])

  @@index([reportId], map: "idx_attendance_record_report")
  @@index([createdById], map: "idx_attendance_record_creator")
}

enum UserRole {
  PROPONENT
  MMT
  REGULATOR
  ADMIN
}

enum OrganizationType {
  PROPONENT
  MMT
  REGULATOR
  GOVERNMENT
  OTHER
}

enum OrganizationMembershipRole {
  OWNER
  MANAGER
  CONTRIBUTOR
  REVIEWER
  OBSERVER
}

enum ProjectAssignmentRole {
  PROPONENT_EDITOR
  MMT_REVIEWER
  REGULATOR_VIEWER
}

enum ConditionType {
  ECC
  EPEP
  OTHER
}

enum ComplianceCategory {
  AIR
  WATER
  NOISE
  HAZARDOUS_WASTE
  FINANCIAL
  SOCIAL
  INFRASTRUCTURE
  BIODIVERSITY
  OTHER
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REVISIONS_REQUIRED
  ARCHIVED
}

enum ValidationStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  NEEDS_INFORMATION
}

enum ValidationOutcome {
  APPROVED
  CONDITIONALLY_APPROVED
  REQUIRES_CORRECTION
  REJECTED
  NOT_APPLICABLE
}

enum ReportType {
  CMR
  CMVR
  SUMMARY
  OTHER
}

enum EvidenceType {
  PHOTO
  VIDEO
  DOCUMENT
  AUDIO
  DATASET
  OTHER
}

enum AttendanceStatus {
  IN_PERSON
  ONLINE
  ABSENT
}
